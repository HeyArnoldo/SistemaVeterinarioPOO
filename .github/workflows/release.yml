# Nombre del workflow de compilación y creación de release
name: Build & Create GitHub Release

on:
  push:
    branches:
      - master # Se activa con pushes a master
  workflow_dispatch: # Permite ejecución manual

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build with Maven
        run: mvn clean package -DskipTests # Genera el .jar en /target

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: spring-boot-jar
          path: target/*.jar
          retention-days: 1 # Solo necesitamos el artefacto para el siguiente job

  create-release:
    # Este job depende de que 'build' termine correctamente
    needs: build
    runs-on: ubuntu-latest

    # Solo necesitamos permisos de 'contents: write' para crear un release
    permissions:
      contents: write

    steps:
      # 1. Descargar el .jar compilado en el job anterior
      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: spring-boot-jar
          # Lo descargará en el directorio actual

      # 2. (Opcional) Listar archivos para depuración
      - name: List files
        run: ls -l

      # 3. (BUENA PRÁCTICA)
      # Reemplazamos 'create-release' y 'upload-release-asset' con una sola acción moderna.
      # Esta acción crea el release Y sube los archivos (assets) en un solo paso.
      - name: Create Release and Upload JAR
        uses: softprops/action-gh-release@v2
        env:
          # Usamos tu secrets.TOKEN como solicitaste
          GITHUB_TOKEN: ${{ secrets.TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Sistema Veterinario v${{ github.run_number }}
          body: |
            Nueva versión automática del Sistema Veterinario.
            Compilado desde el commit: ${{ github.sha }}
          # Esta acción usa 'glob' (patrones) para encontrar los archivos.
          # "*.jar" encontrará el .jar que descargamos en el paso anterior.
          files: "*.jar"
          fail_on_unmatched_files: true
          # Le decimos explícitamente que el nombre del asset en el release debe ser este:
          # (Si no pones esto, usaría el nombre original del JAR de /target)
          # NOTA: Para esta acción, si quieres renombrar, debes hacerlo antes.
          # Vamos a renombrar el JAR primero para asegurar el nombre.

      # 3. Renombrar el JAR (Paso añadido para consistencia)
      - name: Rename JAR
        id: find_jar
        run: |
          JAR_PATH=$(find . -maxdepth 1 -name '*.jar' | head -n 1)
          echo "Renombrando $JAR_PATH a sistema-veterinario.jar"
          mv $JAR_PATH sistema-veterinario.jar
          echo "path=sistema-veterinario.jar" >> $GITHUB_OUTPUT

      # 4. Crear Release y Subir el JAR (Versión final)
      - name: Create Release and Upload JAR
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Sistema Veterinario v${{ github.run_number }}
          body: |
            Nueva versión automática del Sistema Veterinario.
            Compilado desde el commit: ${{ github.sha }}
          # Ahora subimos el archivo con el nombre estandarizado
          files: ${{ steps.find_jar.outputs.path }}
          fail_on_unmatched_files: true