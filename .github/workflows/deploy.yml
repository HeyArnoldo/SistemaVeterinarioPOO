name: Deploy to VPS

on:
  release:
    types: [published] # Se activa cuando el release anterior se publica

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Install sshpass
        run: sudo apt-get install -y sshpass

      # --- ESTE ES EL PASO CRÍTICO CORREGIDO ---
      - name: Download JAR from Release (Correct Method)
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}
        run: |
          LOCAL_JAR_NAME="sistema-veterinario.jar"
          ASSET_API_URL="" # Usaremos la URL de la API del asset, no la del navegador
          
          # URL de la API para consultar los metadatos de este release
          RELEASE_API_URL="${{ github.event.release.url }}"

          echo "Buscando asset 'sistema-veterinario.jar' en el release..."
          echo "Release API URL: $RELEASE_API_URL"

          # Bucle de reintento (esto está bien, lo mantenemos)
          for i in {1..6}; do
            # 1. LLAMAMOS A LA API DE GITHUB
            # Buscamos el asset por el NOMBRE EXACTO que le dimos en el workflow de build
            # Y obtenemos la 'url' (la URL de la API), NO la 'browser_download_url'
            ASSET_API_URL=$(curl -s -L \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "$RELEASE_API_URL" \
              | jq -r '.assets[] | select(.name == "sistema-veterinario.jar") | .url')

            if [ -z "$ASSET_API_URL" ] || [ "$ASSET_API_URL" == "null" ]; then
              echo "Intento $i/6: Asset .jar aún no encontrado. Esperando 10s..."
              sleep 10
            else
              echo "¡Asset encontrado! API URL: $ASSET_API_URL"
              break
            fi
          done
          
          # 2. Comprobar si el asset se encontró
          if [ -z "$ASSET_API_URL" ] || [ "$ASSET_API_URL" == "null" ]; then
            echo "Error: No se encontró el asset 'sistema-veterinario.jar' en el release."
            exit 1
          fi

          # 3. (LA CORRECCIÓN) Descargamos el binario usando la API URL
          echo "Descargando binario desde la API..."
          # Usamos -L para seguir redirecciones
          # Usamos -o para guardar el archivo localmente
          # Usamos la API URL ($ASSET_API_URL) que obtuvimos
          # Pasamos el token de autorización
          # ¡Y el header 'Accept: application/octet-stream' es ESENCIAL!
          # Esto le dice a GitHub "quiero el archivo binario, no el JSON de metadatos".
          curl -L -o $LOCAL_JAR_NAME \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/octet-stream" \
            "$ASSET_API_URL"
          
          echo "Descarga completa. Archivo local: $LOCAL_JAR_NAME"

      - name: Deploy to Server
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          # 1. Copiar el nuevo .jar al servidor (sin cambios)
          echo "Copiando JAR al servidor..."
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no \
            sistema-veterinario.jar \
            $SSH_USER@$SSH_HOST:/home/ubuntu/UTP/sistema-veterinario.jar
          
          # 2. Conectarse por SSH y reiniciar el servicio (sin cambios)
          echo "Reiniciando el servicio en el servidor..."
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no \
            $SSH_USER@$SSH_HOST \
            "sudo systemctl restart sistema-veterinario"
          
          echo "Deploy completo!"