name: Deploy to VPS

# ¡EL DISPARADOR MÁS IMPORTANTE!
# Esto se ejecuta CADA VEZ que se publica un nuevo "Release" en tu repo.
on:
  release:
    types: [published] # Se activa cuando el release es público

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Install sshpass
        run: sudo apt-get install -y sshpass

      - name: Download JAR from Release
        run: |
          # 1. Busca CUALQUIER asset que termine en .jar
          # Esto es mucho más robusto que buscar un nombre fijo
          ASSET_URL=$(echo "${{ toJSON(github.event.release.assets) }}" | \
                      jq -r '.[] | select(.name | endswith(".jar")) | .browser_download_url')
          
          if [ -z "$ASSET_URL" ] || [ "$ASSET_URL" == "null" ]; then
            echo "Error: No .jar asset was found in the release."
            exit 1
          fi

          # 2. Descargamos el .jar y le ponemos el nombre local que esperamos
          echo "Downloading asset from $ASSET_URL"
          curl -L -o sistema-veterinario.jar $ASSET_URL

      - name: Deploy to Server
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          # 1. Copiar el nuevo .jar al servidor usando 'scp'
          # Reemplazará el .jar antiguo en /home/ubuntu/UTP/
          echo "Copying JAR to server..."
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no \
            sistema-veterinario.jar \
            $SSH_USER@$SSH_HOST:/home/ubuntu/UTP/sistema-veterinario.jar
          
          # 2. Conectarse por SSH y reiniciar el servicio
          # systemd se encargará de parar el proceso antiguo e iniciar el nuevo
          echo "Restarting service on server..."
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no \
            $SSH_USER@$SSH_HOST \
            "sudo systemctl restart sistema-veterinario"
          
          echo "Deploy complete!"