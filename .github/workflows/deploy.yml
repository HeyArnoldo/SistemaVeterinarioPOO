name: Deploy to VPS

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Install sshpass
        run: sudo apt-get install -y sshpass

      - name: Download JAR from Release (with API Retry)
        # Añadimos el GITHUB_TOKEN al entorno para poder usar la API
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}
        run: |
          LOCAL_JAR_NAME="sistema-veterinario.jar"
          ASSET_URL=""
          
          # Esta es la URL de la API para este release específico
          RELEASE_API_URL="${{ github.event.release.url }}"

          echo "Buscando asset .jar en el release '${{ github.event.release.tag_name }}'..."
          echo "URL de la API: $RELEASE_API_URL"

          # BUCLE DE REINTENTO:
          # Ahora llama a la API en cada intento
          for i in {1..6}; do
            # 1. LLAMAMOS A LA API DE GITHUB
            # Usamos curl para obtener la lista de assets FRESCA
            # -H "Authorization..." se autentica
            # -H "Accept..." especifica la versión de la API
            # El JSON de salida se pasa directamente a 'jq'
            ASSET_URL=$(curl -s -L \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "$RELEASE_API_URL" \
              | jq -r '.assets[] | select(.name | endswith(".jar")) | .browser_download_url')

            if [ -z "$ASSET_URL" ] || [ "$ASSET_URL" == "null" ]; then
              echo "Intento $i/6: Asset .jar aún no encontrado. Esperando 10s..."
              sleep 10
            else
              echo "¡Asset encontrado en el intento $i!"
              break
            fi
          done
          
          # 2. Comprobar si el asset se encontró después de los reintentos
          if [ -z "$ASSET_URL" ] || [ "$ASSET_URL" == "null" ]; then
            echo "Error: No se encontró ningún asset .jar en el release después de 60s."
            echo "Verifica que el workflow de 'Build' esté subiendo el JAR correctamente."
            exit 1
          fi

          # 3. Descargamos el .jar (Autenticado)
          echo "Downloading asset from $ASSET_URL"
          # -L sigue redirecciones
          # -o lo guarda con el nombre local
          # Necesitamos pasar el Header de "Accept" para descargar el binario
          curl -L -o $LOCAL_JAR_NAME \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/octet-stream" \
            "$ASSET_URL"
          
          echo "Descarga completa. Archivo local: $LOCAL_JAR_NAME"

      - name: Deploy to Server
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          # 1. Copiar el nuevo .jar al servidor
          echo "Copying JAR to server..."
          sshpass -p "$SSH_PASSWORD" scp -o StrictHostKeyChecking=no \
            sistema-veterinario.jar \
            $SSH_USER@$SSH_HOST:/home/ubuntu/UTP/sistema-veterinario.jar
          
          # 2. Conectarse por SSH y reiniciar el servicio
          echo "Restarting service on server..."
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no \
            $SSH_USER@$SSH_HOST \
            "sudo systemctl restart sistema-veterinario"
          
          echo "Deploy complete!"